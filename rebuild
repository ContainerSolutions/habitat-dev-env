#!/usr/bin/make -f

.PHONY: all check start

include results/last_build.env
hab_path = hab/pkgs/$(pkg_origin)/$(pkg_name)/$(pkg_version)/$(pkg_release)/


ifeq ($(DEBUG), 1)
	debug=RUST_LOG=debug RUST_BACKTRACE=1
else
	debug=
endif

all: last_build.hart

results:
	hab pkg build .

last_build.hart: results/$(pkg_artifact) default.toml  $(wildcard config/*) $(wildcard hooks/*)
	tail -n +6 $< | xzcat > $@.tmp
	tar f $@.tmp --delete $(hab_path)config $(hab_path)hooks
	tar rf $@.tmp --transform 's|^|$(hab_path)|' $(wordlist 2, $(words $^), $^)
	xz $@.tmp
	hab pkg sign --origin $(pkg_origin) $@.tmp.xz $@
	rm $@.tmp.xz

check: last_build.hart
	tail -n +6 $< | xzcat | tar t

start: last_build.hart
	sudo rm -rf /$(hab_path)
	sudo $(debug) hab start -v $<
